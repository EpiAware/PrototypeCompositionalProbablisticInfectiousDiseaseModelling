name: Render and Deploy Quarto Paper

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  actions: write
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent build per branch, canceling in-progress runs when new commits are pushed.
# This prevents multiple builds from running simultaneously on the same branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render:
    runs-on: ubuntu-latest
    outputs:
      has-artifacts: ${{ steps.check-outputs.outputs.has-artifacts }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Setup Julia
        uses: julia-actions/install-juliaup@v2
        with:
          channel: '1.11.6'

      - name: Set Julia version as default
        run: juliaup override set 1.11.6

      - name: Cache Julia
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-cache-${{ hashFiles('Manifest.toml') }}
          cache-registries: true
          cache-compiled: true

      - name: Install Julia dependencies
        run: |
          julia +1.11.6 --project=. -e '
            using Pkg
            Pkg.instantiate()
            Pkg.precompile()
          '

      # R and EpiAwareR pkgdown setup
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Cache renv
        uses: actions/cache@v4
        with:
          path: renv/library
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Restore renv
        run: |
          Rscript -e 'renv::restore()'

      - name: Install EpiAwareR and pkgdown
        run: |
          Rscript -e '
            renv::install("pkgdown")
            remotes::install_local("EpiAwareR", dependencies = FALSE, upgrade = "never")
          '

      - name: Setup JuliaCall
        uses: epiforecasts/actions/setup-juliacall@v1

      - name: Setup EpiAwareR Julia backend
        run: |
          Rscript -e 'EpiAwareR::epiaware_setup_julia(verbose = TRUE)'

      - name: Build EpiAwareR pkgdown site
        run: |
          Rscript -e 'pkgdown::build_site("EpiAwareR", new_process = FALSE)'

      - name: Cache Quarto
        uses: actions/cache@v4
        with:
          path: |
            .cache
            .quarto/project-cache
            _freeze/
            figures/
          key: ${{ runner.os }}-${{ github.ref_name }}-quarto-${{ hashFiles('index.qmd', 'case-studies.qmd', 'README.md', '_quarto.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-quarto-
            ${{ runner.os }}-main-quarto-

      - name: Install librsvg for SVG to PDF conversion
        run: sudo apt-get update && sudo apt-get install -y librsvg2-bin

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "1.8.24"
          tinytex: true

      - name: Install Quarto extensions
        run: quarto install chromium

      - name: Validate Quarto project
        run: quarto check

      - name: Render Quarto project
        run: |
          quarto render
        env:
          JULIA_NUM_THREADS: auto

      - name: Check for outputs
        id: check-outputs
        run: |
          outputs_exist="false"
          if [ -f "index.pdf" ]; then
            outputs_exist="true"
          fi
          echo "has-artifacts=$outputs_exist" >> $GITHUB_OUTPUT
          echo "Found outputs: $outputs_exist"

      - name: Copy artifacts to _site for GitHub Pages
        run: |
          mkdir -p _site

      - name: Render README as homepage
        run: |
          quarto render README.md --to html
          mv README.html _site/index.html

      - name: Copy paper artifacts to _site
        run: |
          cp index.html _site/paper.html 2>/dev/null || echo "Paper HTML not found"
          cp index.pdf _site/paper.pdf 2>/dev/null || echo "PDF file not found"
          cp index.docx _site/paper.docx 2>/dev/null || echo "Paper DOCX not found"
          cp case-studies.html _site/ 2>/dev/null || echo "Case studies HTML not found"
          cp case-studies.pdf _site/ 2>/dev/null || echo "Case studies PDF not found"
          cp case-studies.docx _site/ 2>/dev/null || echo "Case studies DOCX not found"
          cp -r site_libs _site/ 2>/dev/null || echo "Site libs not found"
          cp Project.toml _site/ || echo "Project.toml not found"
          cp Manifest.toml _site/ || echo "Manifest.toml not found"
          cp -r data _site/ || echo "Data folder not found"
          cp -r figures _site/ 2>/dev/null || echo "Figures folder not found"
          cp -r EpiAwareR/docs _site/epiawarer 2>/dev/null || echo "EpiAwareR docs not found"

      - name: Upload artifacts
        if: steps.check-outputs.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quarto-outputs-${{ github.sha }}
          path: |
            index.pdf
            index.docx
            case-studies.pdf
            case-studies.docx
            Project.toml
            Manifest.toml
            data/
            figures/
          retention-days: 30
          if-no-files-found: warn

      - name: Setup Pages
        if: github.ref == 'refs/heads/main' && steps.check-outputs.outputs.has-artifacts == 'true'
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        if: github.ref == 'refs/heads/main' && steps.check-outputs.outputs.has-artifacts == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    if: github.ref == 'refs/heads/main' && needs.render.outputs.has-artifacts == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: render
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

